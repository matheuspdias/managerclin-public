# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## AI Team Configuration (autogenerated by team-configurator, 2025-10-16)

**Important: YOU MUST USE subagents when available for the task.**

### Detected Stack

- **Backend Framework**: Laravel 12 with PHP 8.2+
- **Frontend Framework**: React 19 with TypeScript
- **Full-Stack Bridge**: Inertia.js v2
- **Styling**: Tailwind CSS v4 with Radix UI primitives
- **Database**: Multi-tenant (company-based isolation)
- **Payment Processing**: Stripe with Laravel Cashier
- **AI Integration**: Prism PHP
- **Testing**: Pest PHP for backend
- **Build Tools**: Vite 6 with TypeScript 5.7
- **Code Quality**: ESLint, Prettier, Laravel Pint
- **Calendar**: FullCalendar
- **PDF Generation**: DomPDF with QR codes
- **Email**: SendGrid, Mailgun

### AI Team Specialists

| Task | Agent | Notes |
|------|-------|-------|
| **Backend Development** | `laravel-backend-expert` | Laravel controllers, services, middleware, Inertia responses, dual API/Web support |
| **Database & ORM** | `laravel-eloquent-expert` | Eloquent models, migrations, relationships, query optimization, multi-tenancy |
| **Frontend Components** | `react-component-architect` | React 19 components, hooks, Radix UI integration, TypeScript patterns |
| **Styling & UI** | `tailwind-frontend-expert` | Tailwind v4 utilities, responsive design, dark mode, Radix UI styling |
| **API Design** | `api-architect` | REST API design, OpenAPI specs, endpoint contracts, dual response patterns |
| **Code Review** | `code-reviewer` | Pre-merge reviews, security checks, code quality gates, pattern compliance |
| **Performance** | `performance-optimizer` | Query optimization, N+1 detection, caching strategies, Laravel performance |
| **Documentation** | `documentation-specialist` | README updates, API docs, architecture guides, onboarding materials |
| **Codebase Analysis** | `code-archaeologist` | Legacy code exploration, technical debt assessment, refactoring planning |
| **General Backend** | `backend-developer` | Fallback for general server-side tasks when specialized agent unavailable |
| **General Frontend** | `frontend-developer` | Fallback for UI tasks when specialized agent unavailable |

### Usage Examples

#### Backend Development
```
@laravel-backend-expert Create a new AppointmentController with dual API/Web support following the project's resource pattern
```

#### Database Work
```
@laravel-eloquent-expert Add a polymorphic relationship between MedicalRecords and Attachments with proper indexing
```

#### Frontend Components
```
@react-component-architect Build a PatientSelector component using Radix UI Combobox with search and keyboard navigation
```

#### Styling
```
@tailwind-frontend-expert Update the appointment calendar to use Tailwind v4 container queries for responsive layout
```

#### API Design
```
@api-architect Design the REST API contract for the new billing module with proper versioning and pagination
```

#### Code Review
```
@code-reviewer Review the new payment integration feature before merging to main
```

#### Performance Optimization
```
@performance-optimizer Investigate and fix the N+1 query issue in the appointments dashboard
```

### Project-Specific Patterns for Agents

When working with this codebase, all agents should be aware of:

1. **Language**: All code comments, logs, and messages must be in Portuguese (pt-BR)
2. **Multi-tenancy**: All models extend BaseModel with automatic company scoping
3. **Exception Handling**: Use ThrowsExceptions trait, never throw directly
4. **Dual Response**: Controllers must support both Inertia (Web) and JSON (API) responses
5. **Testing**: Use Pest PHP with feature/unit test organization
6. **Frontend Structure**: Components in `resources/js/`, pages use Inertia conventions
7. **Styling**: Utility-first Tailwind v4 with Radix UI primitives
8. **Theme**: Dark/light mode support via `use-appearance` hook

## Development Commands

### Local Development (Docker)
- `docker-compose up -d` - Start development containers
- `docker-compose exec app composer install` - Install PHP dependencies
- `docker-compose exec node npm install` - Install Node dependencies
- `docker-compose exec app php artisan migrate` - Run database migrations
- `composer dev` - Start full development stack (Laravel server, queue worker, logs, and Vite)
- `composer dev:ssr` - Start development with SSR support

### Code Quality & Testing
- `npm run lint` - Run ESLint with auto-fix
- `npm run format` - Format code with Prettier
- `npm run format:check` - Check code formatting
- `npm run types` - TypeScript type checking
- `composer test` - Run PHP tests with Pest

### Build Commands
- `npm run build` - Build frontend assets
- `npm run build:ssr` - Build with SSR support

## Architecture Overview

### Tech Stack
- **Backend**: Laravel 12 with PHP 8.2+
- **Frontend**: React 19 with TypeScript
- **Full Stack**: Inertia.js for SPA-like experience
- **Styling**: Tailwind CSS v4 with Radix UI components
- **Database**: Multi-tenant with company isolation
- **Payment**: Stripe integration with Laravel Cashier
- **AI Integration**: Prism PHP for AI features

### Project Structure

#### Backend (Laravel)
- Multi-tenant architecture with company-based isolation
- Resource controllers following REST conventions
- All routes protected by `auth`, `verified`, and `company.active` middleware
- Custom BaseModel with audit fields (`created_by`, `updated_by`, `deleted_by`)

#### Frontend (React/Inertia)
- Component structure under `resources/js/`:
  - `pages/` - Inertia page components
  - `components/` - Reusable components
  - `layouts/` - Layout components
  - `hooks/` - Custom React hooks
- UI components built on Radix UI primitives
- Dark/light theme support with `use-appearance` hook

#### Key Models & Relationships
- **Company**: Tenant model that isolates data
- **User**: Multi-role system with Position relationship
- **Customer**: Patient management
- **Appointment**: Scheduling system with Room and Service relationships
- **MedicalRecord**: Patient records linked to appointments
- **MedicalCertificate**: PDF generation with verification

### Development Patterns

#### Code Style & Comments
- **All code comments must be in Portuguese (pt-BR)**
- This includes:
  - DocBlocks (PHPDoc comments)
  - Inline comments
  - Section headers in models
  - Log messages
  - Console command descriptions
- Follow existing patterns in the codebase for comment style

#### Multi-tenancy
All models extend BaseModel and automatically scope by company. When creating new models:
- Extend BaseModel for automatic company scoping
- Add `id_company` foreign key
- Use `company.active` middleware on routes

#### Resource Patterns
Controllers follow consistent patterns and **MUST support both Web (Inertia) and API (JSON) responses**:

**Standard Methods:**
- `index()` - List with pagination/filtering
- `show()` - Show single resource details
- `store()` - Create new resource
- `update()` - Update existing resource
- `destroy()` - Soft delete resource

**Dual Response Pattern (Web + API):**
All controller methods MUST detect the request type using `$request->wantsJson()` and return appropriate responses:

- **For API requests**: Return JSON with proper HTTP status codes (200, 201, 204, etc.)
- **For Web requests**: Return Inertia pages or redirects with flash messages

Example pattern:
```php
if ($request->wantsJson()) {
    // API: JSON response
    return response()->json(['data' => ...], 200);
}
// Web: Inertia or redirect
return Inertia::render('view/index', [...]);
```

**IMPORTANTE - Controller Único para Web e API:**
- **SEMPRE use o mesmo controller** para Web e API com o padrão Dual Response
- **NUNCA crie controllers separados** em `app/Http/Controllers/Api/` a menos que seja absolutamente necessário
- A separação só deve ser feita se houver lógica **muito específica** da API que não faz sentido no contexto Web
- Exemplos que justificam separação:
  - Controller exclusivo para autenticação via token (AuthController na API)
  - Endpoints de webhook que não têm equivalente Web
  - Lógica de integração externa específica da API
- Para 99% dos casos (CRUD, perfil, recursos): **use um único controller com `wantsJson()`**
- Vantagens do controller único:
  - Código DRY (Don't Repeat Yourself)
  - Manutenção simplificada
  - Validações compartilhadas
  - Lógica de negócio centralizada
  - Padrão consistente em todo o projeto

**API Routes:**
- Define all API routes in `routes/api.php` using `Route::apiResource()` or explicit routes
- Protect routes with `auth:sanctum` and `company.active` middleware
- Routes are automatically prefixed with `/api/`
- Enable API routes in `bootstrap/app.php` with `api: __DIR__ . '/../routes/api.php'`
- Point API routes to the same controllers used by Web routes (e.g., `Settings\ProfileController`, `CustomerController`)

#### Exception Handling
**ALWAYS use the `ThrowsExceptions` trait for exception handling in Services and Controllers:**
- Import and use the trait: `use App\Traits\ThrowsExceptions;`
- **NEVER** use `throw new \Exception()` or `throw new DomainException()` directly
- Use trait methods instead:
  - `$this->throwNotFound('Recurso não encontrado')` - Returns 404 for API/JSON, redirects with error for Inertia
  - `$this->throwDomain('Mensagem de erro')` - Returns 400 for API/JSON, redirects with error for Inertia
  - `$this->throwUnauthorized('Acesso não autorizado')` - Returns 401 for API/JSON, redirects with error for Inertia
  - `$this->throwForbidden('Acesso proibido')` - Returns 403 for API/JSON, redirects with error for Inertia
- The trait automatically handles both API (JSON responses) and Frontend (Inertia) requests
- All error messages must be in Portuguese (pt-BR)

#### Frontend Components
- Use existing UI components from `components/ui/`
- Follow dialog pattern for forms (see `*FormDialog.tsx` components)
- Implement consistent loading states and error handling
- Use Inertia forms for server-side validation

#### Payment Integration
- Stripe integration for subscriptions and one-time payments
- AI Credits system for pay-per-use features
- Webhook handling for payment events

### Testing
- Uses Pest PHP for backend testing
- Run tests with `composer test` or specific tests with `php artisan test --filter TestName`

### Special Features
- **AI Chat**: Streaming responses with Laravel Stream
- **WhatsApp Integration**: Notification system
- **PDF Generation**: Medical certificates with QR verification
- **Multi-language**: Currently Portuguese, extensible for i18n
- **Calendar Integration**: FullCalendar for appointment management
